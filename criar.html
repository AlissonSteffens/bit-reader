<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Image 2 Bin</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='main.css'>
    <script src='main.js'></script>
</head>

<body>
    <div class="inicio">
        <textarea name="" id="image"></textarea>
        <button onclick="create_image()">Fazer Imagem</button>
        <!--<button onclick="convertDataURIToBinary(evt)"> Converter arquivo escolhido para bin</button> -->
    </div>

    <div id="file-js">

        <input type="file" name="resume"></input>

    </div>

    <canvas id="myCanvas" width="800" height="600"></canvas>
    <script>
        var pixelsize = 10
        // convert 0..255 R,G,B values to a hexidecimal color string
        RGBToHex = function (r, g, b) {
            var bin = r << 16 | g << 8 | b;
            return (function (h) {
                return new Array(7 - h.length).join("0") + h
            })(bin.toString(16).toUpperCase())
        }

        // convert a 24 bit binary color to 0..255 R,G,B
        binToRGB = function (bin) {
            var pbin = parseInt(bin, 2);
            var r = pbin >> 16;
            var g = pbin >> 8 & 0xFF;
            var b = pbin & 0xFF;
            return [r, g, b];
        }

        // convert a hexidecimal color string to 0..255 R,G,B
        hexToRGB = function (hex) {
            var r = hex >> 16;
            var g = hex >> 8 & 0xFF;
            var b = hex & 0xFF;
            return [r, g, b];
        }
        function create_image() {
            var bin = document.getElementById("image").value;
            let linhas = bin.split("\n")
            canvas = document.getElementById('myCanvas')
            canvasContext = canvas.getContext('2d')
            var i, j = 0
            linhas.forEach(element => {
                colunas = element.split(',')
                colunas.pop()
                i = 0
                colunas.forEach(ef => {
                    arr = binToRGB(ef)
                    let r = arr[0]
                    let g = arr[1]
                    let b = arr[2]
                    canvasContext.fillStyle = '#' + RGBToHex(r, g, b)
                    canvasContext.fillRect(i * pixelsize, j * pixelsize, pixelsize, pixelsize)
                    i++
                });
                j++
            });
        }


        // Check for the File API support.
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            document.querySelector('#file-js input[type=file]').addEventListener('change', convertDataURIToBinary, false);

        } else {
            // alert('The File APIs are not fully supported in this browser.');
        }

        var binaryString;
        var u8Array;
        var BASE64_MARKER;

        function convertDataURIToBinary(evt) {

            var f = evt.target.files[0]; 
            var reader = new FileReader();
            reader.onload = (function (theFile) {
                return function (e) {
                    var raw = e.target.result;
                    var rawLength = raw.length;
                    var array = new Uint8Array(new ArrayBuffer(rawLength));
                    for (i = 0; i < rawLength; i++) {
                        array[i] = raw.charCodeAt(i);
                    }
                    
                    u8Array = array;
                    return array;
                    //convertUint8ArrayToWordArray

                    var words = [], i = 0, len = u8Array.length;

while (i < len) {
    words.push(
        (u8Array[i++] << 24) |
        (u8Array[i++] << 16) |
        (u8Array[i++] << 8)  |
        (u8Array[i++])
    );
}

return {
    sigBytes: words.length * 4,
    words: words
};
var i, len = u8Array.length, b_str = "";
	for (i=0; i<len; i++) {
		b_str += String.fromCharCode(u8Array[i]);
    }
    
    binaryString = b_str;
    var elemento = document.getElementById("imagem");
        elemento.innerHTML = binaryString;
	return b_str;
                };
            })(f);
            reader.readAsBinaryString(f);
        }

    </script>
</body>

</html>